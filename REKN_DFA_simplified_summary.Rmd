---
output:
  rmarkdown::pdf_document:
    #theme: journal
---
```{r include = FALSE}

library(dplyr)
library(knitr)
opts_knit$set(eval.after = 'fig.cap')

band2010 <- read.csv("R7MBMlb_REKN_Banding_2010.csv", stringsAsFactors = FALSE)
band2011 <- read.csv("R7MBMlb_REKN_Banding_2011.csv", stringsAsFactors = FALSE)
band2012 <- read.csv("R7MBMlb_REKN_Banding_2012.csv", stringsAsFactors = FALSE)
band2013 <- read.csv("R7MBMlb_REKN_Banding_2013.csv", stringsAsFactors = FALSE)
band2014 <- read.csv("R7MBMlb_REKN_Banding_2014.csv", stringsAsFactors = FALSE)
band2015 <- read.csv("R7MBMlb_REKN_Banding_2015.csv", stringsAsFactors = FALSE)
band2016 <- read.csv("R7MBMlb_REKN_Banding_2016.csv", stringsAsFactors = FALSE)
band2017 <- read.csv("R7MBMlb_REKN_Banding_2017.csv", stringsAsFactors = FALSE)
band2018 <- read.csv("R7MBMlb_REKN_Banding_2018.csv", stringsAsFactors = FALSE)
band2019 <- read.csv("R7MBMlb_REKN_Banding_2019.csv", stringsAsFactors = FALSE)

allband <- rbind(band2019, band2018, band2017, band2016, band2015, band2014, band2013, band2012, band2011, band2010)

#filter by adults and REKN in Nome
allbandadults <- allband %>% filter(
  AgeID == "AHY" | AgeID == "ASY" | AgeID == "ATY",
  Species == "REKN") %>%
  droplevels

all.sexed.adults <- allbandadults %>% filter(
  CHDSex == "M" | CHDSex == "F") %>%
  droplevels

unk.subset <- band2016 %>% filter(
  AgeID == "AHY" | AgeID == "ASY" | AgeID == "ATY",
  Species == "REKN") %>%
  droplevels

unk.subset <- unk.subset %>% filter(
  CHDSex == "M" | CHDSex == "F") %>%
  droplevels

#pull select fields with minimal NAs
df <- dplyr::select(all.sexed.adults, CHDSex, Culmen, TotalHead, TarsusDiagonal, Wing)
df <- na.omit(df)

df$CHDSex <- as.factor(df$CHDSex)

#Red GH banding file
GHband <- read.csv("R7MBMlb_GH_banding.csv", stringsAsFactors = FALSE)

dfGH<- GHband %>% filter(
  CHDSex == "M" | CHDSex == "F") %>%
  droplevels

#remove unnecessary columns
dfGH<- dplyr::select(dfGH, CHDSex, Culmen, TotalHead, TarsusDiagonal, Wing)
dfGH<- na.omit(dfGH)

dfGH$CHDSex <- as.factor(dfGH$CHDSex)



all.rekn <- rbind(df,dfGH)
all.rekn.m <- all.rekn %>% filter(CHDSex == "M") %>% droplevels
all.rekn.f <- all.rekn %>% filter(CHDSex == "F") %>% droplevels


df.m <- df %>% filter(CHDSex == "M") %>% droplevels
df.f <- df %>% filter(CHDSex == "F") %>% droplevels
dfGH.m <- dfGH %>% filter(CHDSex == "M") %>% droplevels
dfGH.f <- dfGH %>% filter(CHDSex == "F") %>% droplevels

t.test(all.rekn.m$TotalHead, all.rekn.f$TotalHead, var.equal = TRUE, paired = FALSE)
t.test(all.rekn.m$Wing, all.rekn.f$Wing, var.equal = TRUE, paired = FALSE)
t.test(all.rekn.m$TarsusDiagonal, all.rekn.f$TarsusDiagonal, var.equal = TRUE, paired = FALSE)
t.test(all.rekn.m$Culmen, all.rekn.f$Culmen, var.equal = TRUE, paired = FALSE)


t.test(df.m$TotalHead, dfGH.m$TotalHead, var.equal = TRUE, paired = FALSE)
t.test(df.m$Wing, dfGH.m$Wing, var.equal = TRUE, paired = FALSE)
t.test(df.m$TarsusDiagonal, dfGH.m$TarsusDiagonal, var.equal = TRUE, paired = FALSE)
t.test(df.m$Culmen, dfGH.m$Culmen, var.equal = TRUE, paired = FALSE)

t.test(df.f$TotalHead, dfGH.f$TotalHead, var.equal = TRUE, paired = FALSE)
t.test(df.f$Wing, dfGH.f$Wing, var.equal = TRUE, paired = FALSE)
t.test(df.f$TarsusDiagonal, dfGH.f$TarsusDiagonal, var.equal = TRUE, paired = FALSE)
t.test(df.f$Culmen, dfGH.f$Culmen, var.equal = TRUE, paired = FALSE)



```

```{r include = FALSE}
##Multiplot function
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)
  
  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)
  
  numPlots = length(plots)
  
  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }
  
  if (numPlots==1) {
    print(plots[[1]])
    
  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))
    
    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))
      
      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

```
## Red Knot DFA Simplified Summary

This is a brief summary of the DFA conducted on roselaari Red Knots. The purpose of this work is to determine a formula to be used in the field to sex birds for satellite attachement purposes. 

### Sample Size

 We have `r nrow(df)` molecularly sexed birds from Nome and `r nrow(dfGH)` molecularly sexed birds from Grays Harbor that have the four core measurements -- diagonal tarsus, wing, total head, and culmen. We have a male bias sample from both Nome, AK (`r signif(nrow(df.m)/ nrow(df) * 100,3)`% male) and Grays Harbor, WA (`r signif(nrow(dfGH.m)/ nrow(dfGH) * 100,3)`% male). The extremely bias ratio in Nome is due to our capture techniques targeting brood rearing birds in recent years. 


### Male-Female Sexual Size Dimorphism

As expected, females were significantly larger in three out of four of our measurements. Females were significantly larger in total head (*P*<.001), culmen (*P*<.001), and wing (*P*<.001), but not significantly larger in diagonal tarsus (*P*=.12).

```{r echo=FALSE, fig.align='center', fig.cap = cap}
library(ggplot2)

p1 <- ggplot(all.rekn,aes(x=Culmen, fill=CHDSex)) + geom_density(alpha=0.25, adjust = 2.5)
p2 <- ggplot(all.rekn,aes(x=TotalHead, fill=CHDSex)) + geom_density(alpha=0.25, adjust = 2.5)
p3 <- ggplot(all.rekn,aes(x=TarsusDiagonal, fill=CHDSex)) + geom_density(alpha=0.25, adjust = 2.5)
p4 <- ggplot(all.rekn,aes(x=Wing, fill=CHDSex)) + geom_density(alpha=0.25, adjust = 2.5)
multiplot(p1, p2, p3, p4, cols = 2)
cap <- "Figure 2. Density plots of each sexes measurements. Culmen, total head, and wing are the only measurments that showed significant difference between the two sexes."
```



### Using DFA to guide field sexing

Using a automated stepwise approach, total head and wing were selected as the best variables to accurately sex birds. 
```{r, echo=FALSE, message=FALSE}
library(klaR)
modelstepL <- stepclass(CHDSex ~ ., "lda", direction = "both", data = all.rekn, improvement = 0.001, fold = 189)

modelstepL
```

A cross-validated review of all biologically relevant variables while omitting highly correlated variables (total head and culmen, r=0.86) in the same model, resulted in total head, wing, and tarsus predicting sex with the highest accuracy. The two-variable model (total head and wing) selected by the automated approach was a very close second, and is more meaningful given the lack of separation between males and females in diagonal tarsus. Moving forward, we will use the total head and wing model.

```{r include = FALSE}
percentage.to.remove <- 1 # Remove % of points
number.to.remove <- trunc(nrow(all.rekn) * percentage.to.remove / 100)

#Look for outliers using all measurements
m.dist <- mahalanobis(all.rekn[, 2:5], colMeans(all.rekn[, 2:5]), cov(all.rekn[, 2:5]))
m.dist.order <- order(m.dist, decreasing=TRUE)
rows.to.keep.index <- m.dist.order[(number.to.remove+1):nrow(all.rekn[, 2:5])]
#remove the top 2% of outliers
all.rekn.outliers.out <- all.rekn[rows.to.keep.index,]

```

```{r, message=FALSE}
library(MASS)

#lda using all variables
jacknife1 <- lda(CHDSex~.,data = all.rekn.outliers.out, CV = TRUE)
#lda using culmen, wing, and tarsus
jacknife2 <- lda(CHDSex~ Culmen + Wing + TarsusDiagonal, data = all.rekn.outliers.out, CV = TRUE)
#lda using culmen, wing, and total head
jacknife3 <- lda(CHDSex~ TotalHead + Wing + TarsusDiagonal, data = all.rekn.outliers.out, CV = TRUE)
#lda using total head and wing
jacknife4 <- lda(CHDSex~ TotalHead + Wing, data = all.rekn.outliers.out, CV = TRUE)
#lda using culmen and wing
jacknife5 <- lda(CHDSex~ Culmen + Wing, data = all.rekn.outliers.out, CV = TRUE)

```

```{r echo=FALSE, message=FALSE}

jacknife1.acc <- table(all.rekn.outliers.out$CHDSex, 
                       jacknife1$class, dnn = c("Actual Group", "Predicted Group"))
jacknife2.acc <- table(all.rekn.outliers.out$CHDSex, 
                       jacknife2$class, dnn = c("Actual Group", "Predicted Group"))
jacknife3.acc <- table(all.rekn.outliers.out$CHDSex, 
                       jacknife3$class, dnn = c("Actual Group", "Predicted Group"))
jacknife4.acc <- table(all.rekn.outliers.out$CHDSex, 
                       jacknife4$class, dnn = c("Actual Group", "Predicted Group"))
jacknife5.acc <- table(all.rekn.outliers.out$CHDSex, 
                       jacknife5$class, dnn = c("Actual Group", "Predicted Group"))

library(caret)

cm1 <- caret::confusionMatrix(jacknife1.acc)
cm2 <- caret::confusionMatrix(jacknife2.acc)
cm3 <- caret::confusionMatrix(jacknife3.acc)
cm4 <- caret::confusionMatrix(jacknife4.acc)
cm5 <- caret::confusionMatrix(jacknife5.acc)


```

Model output for total head, wing, and tarsus. Note the accuracy is very similar to total head and wing. Tarsus did not do much to imporve the model, and any improvements could have been due to random chance.
```{r echo=FALSE,}
#Total head, wing, and tarsus
cm3


```

Model output for total head and wing. Note this model's accuracy is very similar to total head, wing, and tarus.
```{r echo=FALSE,}
#Total head, wing
cm4
```

The table output shows the total head and wing model correctly classified `r cm4$table[1,1]` females and incorrectly classified `r cm4$table[2,1]` females as males, and correctly classified `r cm4$table[2,2]` males and incorrectly classified `r cm4$table[1,2]` males as females. The confusion matrix can be seen below.

```{r echo=FALSE,}
cm4$table
```

This resulted in accurately classifying 84.57% of individuals with 95% CI (78.6%, 89.42%)

### Equation for field sexing

Using the total head and wing model, we can extract the coefficients to create an equation for field sexing an individual.

```{r}
#run the lda with Total Head, Wing, and Tarsus as variables
lda4 <- lda(CHDSex~ TotalHead + Wing, data = all.rekn.outliers.out)

lda4
```
<br/><br/>

<center> $-0.1001247 Wing - 0.4974653 Total Head = LD1$ </center>  

<br/><br/>

Larger LD1 values indicate the bird is more likely male, while lower LD1 values indicate the bird is more likely female. This model correctly predicted `r signif(cm4$table[2,2]/(cm4$table[2,2] + cm4$table[1,2]) *100, 3)`% of males and `r signif(cm4$table[1,1]/(cm4$table[1,1] + cm4$table[2,1])*100,3)`% of females, for an overall accuracy of  84.6%. Is this enough to guide sexing in the field? We can create new LD1 cutoffs to try and increase this accuracy if necessary.  With -1 and 0.59 set as LD1 sexing cutoffs, this sexed 52.3% of the 189 individuals and 95% of individuals greater than 0.59 were male, and 95% of individuals less than -1 were female. These cutoffs should be adjusted based on project goals and acceptable false-positive risk.

```{r fig.align='center'}

predict4 <- predict(lda4, newdata = all.rekn.outliers.out)

predict4.df <- data.frame(type = all.rekn.outliers.out[,1], lda = predict4$x)

```

```{r, echo=FALSE, fig.align='center'}
ggplot(predict4.df, aes(LD1, fill = type)) +
  geom_histogram( alpha = .5, position = "identity", binwidth = .2) +
  geom_vline(xintercept = -1, linetype="dashed") +
  geom_vline(xintercept = .59, linetype="dashed") 
```